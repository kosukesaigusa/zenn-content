---
title: "Flutter x Firestore ã§ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Flutter", "Firestore"]
published: false
---

## æœ¬è¨˜äº‹ã®ã‚´ãƒ¼ãƒ«

æœ¬è¨˜äº‹ã§ã¯ã€Flutter x Firestore ã§ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

ã‚´ãƒ¼ãƒ«ã¯æ¬¡ã®å‹•ç”»ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚

TODO: ã‚ã¨ã§å‹•ç”»ãªã©ã‚’ã¯ã‚‹

## ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒª

æœ¬è¨˜äº‹ã®ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒªã§ã™ï¼š

@[card](https://github.com/KosukeSaigusa/flutter-infinite-scroll-chat)

æœ¬è¨˜äº‹ã§å–ã‚Šä¸Šã’ã‚‹ã™ã¹ã¦ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§é©å®œå‚ç…§ã—ã¦ãã ã•ã„ã€‚

## å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½ã¨ç‰¹å¾´

æœ¬è¨˜äº‹ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€æ¬¡ã®ã‚ˆã†ãªæ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

- ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã«å…¥ã£ãŸã¨ãã«ã€æœ€æ–° 10 ä»¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã ã‘ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹
- éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ä¸€æ°—ã«ã™ã¹ã¦å–å¾—ã™ã‚‹ã“ã¨ãªãã€ç”»é¢ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦é¡ã‚‹ã®ã«å¾“ã£ã¦ 10 ä»¶ãšã¤å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹
- ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã«å…¥ã£ãŸæ™‚é–“ä»¥é™ã®æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã™ã¹ã¦å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹

ä¸€èˆ¬ã«ã€ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒšãƒ¼ã‚¸ã®åˆ‡ã‚Šæ›¿ãˆã‚’ã™ã‚‹ã“ã¨ãªãã€ç”»é¢ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è‡ªå‹•çš„ã«èª­ã¿è¾¼ã‚“ã§ã„ãã‚ˆã†ãªæ©Ÿèƒ½ã‚’æŒ‡ã—ã¾ã™ã€‚

ãã‚Œã«åŠ ãˆã¦æœ¬è¨˜äº‹ã§ã¯ã€ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’å–ã‚Šä¸Šã’ã‚‹ã“ã¨ã§ã€éå»ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã¯ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§å°‘ã—ãšã¤èª­ã¿è¾¼ã¿ã€é€”ä¸­ã§ã‚„ã£ã¦ãã‚‹æœ€æ–°ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã™ã¹ã¦å–å¾—ã™ã‚‹ã€ã¨ã„ã†æ©Ÿèƒ½ã®ä¸¡ç«‹ã‚’å›³ã‚‹å®Ÿè£…ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ Cloud Firestore ã‚’ç”¨ã„ã¦ã„ã‚‹ã®ã§ã€ã“ã®å®Ÿè£…ã‚’ã™ã‚‹ã“ã¨ã§ã€ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã«å¿…è¦ãªä½“é¨“ã‚’æãªã†ã“ã¨ãªãã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®èª­ã¿å–ã‚Šå›æ•°ï¼ˆã‚³ã‚¹ãƒˆï¼‰ã‚’æœ€é©åŒ–ã™ã‚‹æ–¹æ³•ã‚’å­¦ã¶ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚

ã¾ãŸã€Cloud Firestore ã®åˆ©ç”¨ã®æœ‰ç„¡ã‚„ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®å®Ÿè£…ã‹ã©ã†ã‹ã«ã‹ã‹ã‚ã‚‰ãšã€Flutter ã§ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Ÿè£…ã™ã‚‹ã¨ãã®å‚è€ƒã«ã‚‚ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

## ç™»å ´ã™ã‚‹ã‚¯ãƒ©ã‚¹

ä»Šå›ã¯ä¸»ã«ã€æ¬¡ã® 3 ã¤ã®ã‚¯ãƒ©ã‚¹ã«åˆ†ã‘ã¦å®Ÿè£…ã‚’è¡Œã„ã¾ã™ã€‚

- `ChatRoomPage` ã‚¯ãƒ©ã‚¹ï¼šãƒãƒ£ãƒƒãƒˆç”»é¢ã® UI ã‚’æ§‹æˆã™ã‚‹ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ (`ConsumerWidget`)
- `ChatController` ã‚¯ãƒ©ã‚¹ï¼šãƒãƒ£ãƒƒãƒˆç”»é¢ã§ã®å„ç¨®æ“ä½œã‚’è§£é‡ˆã—ã€`Chat` ãƒ¢ãƒ‡ãƒ«ã‚’æ“ä½œã™ã‚‹
- `Chat` ã‚¯ãƒ©ã‚¹ï¼š`Chat` ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã€ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®ãµã‚‹ã¾ã„ã‚’è¡¨ç¾ã™ã‚‹

`riverpod`, `freezed`, `cloud_firestore` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åˆ©ç”¨ã‚’å‰æã¨ã—ãŸå®Ÿè£…ãƒ»èª¬æ˜ã¨ãªã£ã¦ã„ã‚‹ã®ã§ã€åŒæ§˜ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç”¨ã„ãªã„å ´åˆã¯é©å®œèª­ã¿æ›¿ãˆã¦ãã ã•ã„ã€‚

## UI (ChatRoomPage) ã®å®Ÿè£…

æœ¬è¨˜äº‹ã§ã¯ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã¨ã—ã¦ãã‚Œã£ã½ã„ç”»é¢ã‚’ä½œã‚‹ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®çµ„ã¿æ–¹ã®è©³ç´°ã®èª¬æ˜ã¯è¡Œã„ã¾ã›ã‚“ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

é‡è¦ãªç®‡æ‰€ã ã‘æŠœãå‡ºã—ãŸã‚Šã€èª¬æ˜ã®ãŸã‚ã«ä¸€éƒ¨ã‹ã‚“ãŸã‚“ã«ã—ãŸã‚Šã—ã¦ã€æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```dart:lib/features/chat/ui/chat_room_page.dart
/// ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ç”»é¢ã€‚
class ChatRoomPage extends ConsumerWidget {
  const ChatRoomPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã® IDï¼ˆã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã§ã¯ Provider çµŒç”±ã§ Route ã®ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã™ã‚‹ã‚ˆã†ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ï¼‰ã€‚
    final chatRoomId = 'some-chat-room-id';
    // ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€‚
    final controller = ref.watch(chatControllerProvider(chatRoomId));
    // å–å¾—ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ã€‚
    final messages = ref.watch(chatProvider(chatRoomId).select((s) => s.messages));
    return Scaffold(
      // messages.length ã®æ•°ã ã‘
      // _MessageItem ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ ListView.builder ã§ä¸¦ã¹ã‚‹ã€‚
      body: ListView.builder(
        // ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã® ScrollController ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
        controller: controller.scrollController,
        itemBuilder: (context, index) => _MessageItem(message: messages[index]),
        itemCount: messages.length,
        reverse: true,
      ),
    );
  }
}
```

å¤šãã‚ã‚Šã¾ã›ã‚“ãŒã€æ³¨ç›®ã™ã¹ããƒã‚¤ãƒ³ãƒˆã¯

- `ChatRoomController` ã‚¯ãƒ©ã‚¹ã® `ScrollController` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã€`ListView` ã® `controller` å±æ€§ã«æŒ‡å®šã—ã¦ã„ã‚‹ã“ã¨
- `Chat` ã‚¯ãƒ©ã‚¹ã® `messages` ã®æ•°ã ã‘ã€`ListView.builder` ã§ `MessageItem` ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ä¸¦ã¹ã¦ã„ã‚‹ã“ã¨

ãã‚‰ã„ã§ã—ã‚‡ã†ã‹ã€‚

`ChatRoomController` ã‚¯ãƒ©ã‚¹ã«è¨˜è¿°ã—ã¦ã„ã‚‹ `ScrollController` ã®ãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šã«ã‚ˆã£ã¦ã€ç”»é¢ã‚’ã‚ã‚‹ç¨‹åº¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹æ¬¡ã® 10 ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ï¼ˆå¾Œè¿°ï¼‰ã€‚

`ref.watch` ã§ `chatProvider` ã‚’ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã‚‹ã®ã§ã€`messages` å¤‰æ•°ã«å¤‰æ›´ãŒã‚ã‚‹ï¼ˆæ–°ãŸãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚Œã‚‹ï¼‰ã”ã¨ã«ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ç”»é¢ä¸Šã«ãã‚Œã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚

## ChatControllerï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ï¼‰ã®å®Ÿè£…

æ¬¡ã« `ChatController` ã‚¯ãƒ©ã‚¹ã®èª¬æ˜ã‚’è¡Œã„ã¾ã™ã€‚è¡Œã£ã¦ã„ã‚‹ã“ã¨ã¯ãã‚Œã»ã©å¤šãã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãŸã€å ´åˆã«ã‚ˆã£ã¦ã¯ä¸Šè¨˜ã® UI ã‚’ `StatefulWidget` ã«ã™ã‚‹ã“ã¨ã§åŒç­‰ã®å®Ÿè£…ã‚’è¡Œã£ã¦ã‚‚è‰¯ã„ã§ã—ã‚‡ã†ã€‚

é‡è¦ãªç®‡æ‰€ã ã‘æŠœãå‡ºã—ãŸã‚Šã€èª¬æ˜ã®ãŸã‚ã«ä¸€éƒ¨ã‹ã‚“ãŸã‚“ã«ã—ãŸã‚Šã—ã¦ã€æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

```dart:lib/features/chat/chat_controller.dart
final chatControllerProvider = Provider.autoDispose.family<ChatController, String>(
  (ref, chatRoomId) => ChatController(ref, ref.read(chatProvider(chatRoomId).notifier)),
);

/// ãƒãƒ£ãƒƒãƒˆç”»é¢ã§ã®å„ç¨®æ“ä½œã‚’è¡Œã†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€‚
class ChatController {
  ChatController(this._ref, this._chat) {
    _initialize();
    _ref.onDispose(() async {
      await _newMessagesSubscription.cancel();
      scrollController.dispose();
    });
  }

  final AutoDisposeProviderRef<ChatController> _ref;

  /// ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
  final Chat _chat;

  /// æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã€‚
  late final StreamSubscription<List<Message>> _newMessagesSubscription;

  /// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ ListView ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€‚
  late final ScrollController scrollController;

  /// ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§å–å¾—ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¶æ•°ã® limit å€¤ã€‚
  static const _limit = 10;

  /// ç”»é¢ã®ä½•å‰²ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸæ™‚ç‚¹ã§æ¬¡ã® _limit ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹ã‹ã€‚
  static const _scrollValueThreshold = 0.8;
}

  /// åˆæœŸåŒ–å‡¦ç†ã€‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã‚³ãƒ¼ãƒ«ã™ã‚‹ã€‚
  void _initialize() {
    _initializeScrollController();
    _initializeNewMessagesSubscription();
  }

  /// ListView ã® ScrollController ã‚’åˆæœŸåŒ–ã—ã¦ã€
  /// éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é¡ã£ã¦å–å¾—ã™ã‚‹ãŸã‚ã® Listener ã‚’è¨­å®šã™ã‚‹ã€‚
  void _initializeScrollController() {
    scrollController = ScrollController()
      ..addListener(() async {
        final scrollValue = scrollController.offset / scrollController.position.maxScrollExtent;
        if (scrollValue > _scrollValueThreshold) {
          await _chat.loadMore(limit: _limit);
        }
      });

  /// èª­ã¿å–ã‚Šé–‹å§‹æ™‚åˆ»ä»¥é™ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è³¼èª­ã—ã¦
  /// ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ messages ã«åæ˜ ã•ã›ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’åˆæœŸåŒ–ã™ã‚‹ã€‚
  void _initializeNewMessagesSubscription() {
    _newMessagesSubscription = _chat.newMessagesSubscription;
  }
}
```

ã¾ãšã¯ `ChatController` ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨ãƒ¡ãƒ³ãƒå¤‰æ•°ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°ã¨ã—ã¦ `Chat` ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å—ã‘å–ã‚Šã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸­ã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãª `_initialize()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ï¼ˆå¾Œè¿°ï¼‰ã€‚

ãã®ä»–ã€æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚„å‰è¿°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ã® `ListView` ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã® `controller` å±æ€§ã«æŒ‡å®šã™ã‚‹ `ScrollController` å‹ã®å¤‰æ•°ã‚’ãƒ¡ãƒ³ãƒã¨ã—ã¦å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

`_limit` ã¯ã€ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§å–å¾—ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä»¶æ•°ã‚’ã€`_scrollValueThreshold` ã¯ç”»é¢ã®ä½•å‰²ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸæ™‚ç‚¹ã§ã•ã‚‰ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é¡ã£ã¦å–å¾—ã™ã‚‹ã‹ã®é–¾å€¤ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

```dart:lib/features/chat/chat_controller.dart
/// ãƒãƒ£ãƒƒãƒˆç”»é¢ã§ã®å„ç¨®æ“ä½œã‚’è¡Œã†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€‚
class ChatController {
  ChatController(this._ref, this._chat) {
    _initialize();
    _ref.onDispose(() async {
      await _newMessagesSubscription.cancel();
      scrollController.dispose();
    });
  }

  final AutoDisposeProviderRef<ChatController> _ref;

  /// ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€‚
  final Chat _chat;

  /// æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã€‚
  late final StreamSubscription<List<Message>> _newMessagesSubscription;

  /// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ ListView ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€‚
  late final ScrollController scrollController;

  /// ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§å–å¾—ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¶æ•°ã® limit å€¤ã€‚
  static const _limit = 10;

  /// ç”»é¢ã®ä½•å‰²ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸæ™‚ç‚¹ã§æ¬¡ã® _limit ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹ã‹ã€‚
  static const _scrollValueThreshold = 0.8;
}
```

`_initialize()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

`_initializeScrollController()` ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€`ScrollController` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ `scrollController` å¤‰æ•°ã«æ ¼ç´ã—ãŸä¸Šã§ã€`addLister` ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®å¤‰åŒ–ã‚’ãƒªãƒƒã‚¹ãƒ³ã—ã¾ã™ã€‚

ãƒªã‚¹ãƒŠãƒ¼ã®ä¸­ã§ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ãŒé–¾å€¤ã‚’è¶…ãˆãŸã¨ãã« `Chat` ãƒ¢ãƒ‡ãƒ«ã® `loadMore()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã§ã€æ¬¡ã® `_limit` ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¾ã™ï¼ˆå¾Œè¿°ï¼‰ã€‚

`_newMessagesSubscription` å¤‰æ•°ã«ã¯å˜ã« `Chat` ãƒ¢ãƒ‡ãƒ«ã®åŒåã®å¤‰æ•° (getter) ã®å€¤ã‚’æ ¼ç´ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

```dart:lib/features/chat/chat_controller.dart
class ChatController {
  // ... çœç•¥

  /// åˆæœŸåŒ–å‡¦ç†ã€‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã‚³ãƒ¼ãƒ«ã™ã‚‹ã€‚
  void _initialize() {
    _initializeScrollController();
    _initializeNewMessagesSubscription();
  }

  /// ListView ã® ScrollController ã‚’åˆæœŸåŒ–ã—ã¦ã€
  /// éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é¡ã£ã¦å–å¾—ã™ã‚‹ãŸã‚ã® Listener ã‚’è¨­å®šã™ã‚‹ã€‚
  void _initializeScrollController() {
    scrollController = ScrollController()
      ..addListener(() async {
        final scrollValue = scrollController.offset / scrollController.position.maxScrollExtent;
        if (scrollValue > _scrollValueThreshold) {
          await _chat.loadMore(limit: _limit);
        }
      });

  /// èª­ã¿å–ã‚Šé–‹å§‹æ™‚åˆ»ä»¥é™ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è³¼èª­ã—ã¦
  /// ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ messages ã«åæ˜ ã•ã›ã‚‹ãƒªã‚¹ãƒŠãƒ¼ã‚’åˆæœŸåŒ–ã™ã‚‹ã€‚
  void _initializeNewMessagesSubscription() {
    _newMessagesSubscription = _chat.newMessagesSubscription;
  }
}
```
