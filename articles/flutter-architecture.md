---
title: "マルチパッケージを活用した Flutter のアーキテクチャ"
emoji: "📝"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Dart", "Flutter"]
published: false
published_at: 2024-08-01 00:00
---

## はじめに

これまで本業、副業、プライベートで様々なプロジェクトの開発に携わってきて、それぞれのプロジェクトで様々な課題に直面してきました。

また、直近でも全く新しい Flutter のプロジェクトを立ち上げるにあたり、どのようなアーキテクチャにすれば長期的に恩恵を受けることができるかを考えてきました。

この記事では、そのような過程でまとまってきた、マルチパッケージを活用した Flutter のアーキテクチャについて紹介します。

## この記事で触れること

この記事では、Flutter のアーキテクチャについて説明するにあたり、下記のような内容に触れます。

- Dart, Flutter のパッケージと依存関係について
- Dart と Flutter の境界について
- ドキュメンテーションについて
- 例外処理について
- ユニットテストについて
- ... など

## この記事で紹介するアーキテクチャ

## feature ファーストか layer ファーストか？

いろいろな作法が見受けられる Flutter アプリのアーキテクチャに関する議論をする時、ディレクトリやパッケージをどのように切るか、という観点で、feature ファーストか layer ファーストかというトピックがあがります。

この記事では、PDS (Presentation Domain Separation) の考えに従って、特に UI と Model の境界を明確に layer ファーストでパッケージで分けつつ、各 layer（パッケージ）内では feature ファーストっぽく切る部分もある、というアプローチを取ります。

## なぜ layer ファーストなのか

layer ファーストで分けるということは、各レイヤーの責務と依存関係を主眼に置いて構成を考えるということです。

クライアントアプリケーションにおいて、最も強烈に区別するべきレイヤーは UI と Model であるという考えを取ります。

UI (User Interface) とはその名の通り、ユーザーとシステムの境界です。

画面に映し出された、ユーザーが目にする内容 (View) と、典型的にはボタンのような部品をユーザーが触って何らかの操作を行う部分 (Controller) から成ります。

Model は UI 以外のすべてで、システムの振る舞いそのものを含みます。

格闘ゲームを例にするならば、画面に映る情報が View、プレイヤーが手にするコントローラが Controller、キャラクターの挙動や、ヒット判定、ヒット時のダメージ計算や吹っ飛び率の計算などの格闘ゲームの振る舞いを司るのが Model です。

UI と Model の境界は、Flutter 開発においては Flutter の世界と Dart の世界の境界とほとんど一致します。

Flutter の世界では、ウィジェットが所望の View を形成します。

また、その中でもボタンのようなユーザー操作からトリガーされるようなウィジェットの `onPressed` の処理が Controller の処理を担当します。

一方で、その先の業務知識を表すエンティティ定義や、業務知識に基づく計算処理、通信処理などは、それ自体は Dart のみで記述できるものです。

Dart のみで記述された Model は、本来、単体テストも Dart のみで容易に行うことができます。

業務知識に依存するアプリケーションの振る舞いそのものである Model の単体テストを、低いコストで記述できることは、大きなメリットです。

Model のコードが、十分なドキュメンテーションとともに、業務知識を正しく表現した上で、UI に公開するべきインターフェースとして適切に設計されたもので、その正しさが単体テストで保証されていれば、理想的には Model のソースコード自体がアプリケーションの（UI を除く）振る舞いの仕様書として機能するでしょう。

## パッケージとはなにか

Dart のパッケージとは、

## なぜパッケージに分けるのか

パッケージに分けると、

## Dart と Flutter の境界について

## system パッケージ

## repository パッケージ

## domain パッケージ

## base_ui パッケージ

## app パッケージ

## 例外ハンドリング

## 依存性の注入
